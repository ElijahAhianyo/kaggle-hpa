# Tools Download

[_Documentation generated by Documatic_](https://www.documatic.com)

<!---Documatic-section-Codebase Structure-start--->
## Codebase Structure

<!---Documatic-block-system_architecture-start--->
```mermaid
None
```
<!---Documatic-block-system_architecture-end--->

# #
<!---Documatic-section-Codebase Structure-end--->

<!---Documatic-section-tools.download.download_single_image-start--->
## [tools.download.download_single_image](6-tools_download.md#tools.download.download_single_image)

<!---Documatic-section-download_single_image-start--->
<!---Documatic-block-tools.download.download_single_image-start--->
<details>
	<summary><code>tools.download.download_single_image</code> code snippet</summary>

```python
def download_single_image(i, base_url, save_dir, image_size):
    colors = ['red', 'green', 'blue', 'yellow']
    img_id = i.split('_', 1)
    for color in colors:
        img_path = img_id[0] + '/' + img_id[1] + '_' + color + '.jpg'
        img_name = i + '_' + color + '.png'
        out_filename = os.path.join(save_dir, img_name)
        if os.path.exists(out_filename):
            continue
        img_url = base_url + img_path
        try:
            r = requests.get(img_url, allow_redirects=True, stream=True)
            r.raw.decode_content = True
            im = Image.open(r.raw)
            im = im.resize(image_size, Image.LANCZOS).convert('L')
            im.save(os.path.join(save_dir, img_name), 'PNG')
        except Exception as e:
            print(e)
            return False
    return True
```
</details>
<!---Documatic-block-tools.download.download_single_image-end--->
<!---Documatic-section-download_single_image-end--->

# #
<!---Documatic-section-tools.download.download_single_image-end--->

<!---Documatic-section-tools.download.download-start--->
## [tools.download.download](6-tools_download.md#tools.download.download)

<!---Documatic-section-download-start--->
```mermaid
flowchart LR
tools.download.download-->tools.download.download_single_image
```

### Object Calls

* [tools.download.download_single_image](6-tools_download.md#tools.download.download_single_image)

<!---Documatic-block-tools.download.download-start--->
<details>
	<summary><code>tools.download.download</code> code snippet</summary>

```python
def download(pid, image_list, base_url, save_dir, image_size=(512, 512)):
    while len(image_list) > 0:
        print('try to download {} images'.format(len(image_list)))
        try:
            failed_ids = []
            for i in tqdm(image_list, postfix=pid):
                if not download_single_image(i, base_url, save_dir, image_size):
                    failed_ids.append(i)
            image_list = failed_ids
        except Exception as e:
            print(e)
```
</details>
<!---Documatic-block-tools.download.download-end--->
<!---Documatic-section-download-end--->

# #
<!---Documatic-section-tools.download.download-end--->

<!---Documatic-section-tools.download.main-start--->
## [tools.download.main](6-tools_download.md#tools.download.main)

<!---Documatic-section-main-start--->
<!---Documatic-block-tools.download.main-start--->
<details>
	<summary><code>tools.download.main</code> code snippet</summary>

```python
def main():
    process_num = 24
    image_size = (512, 512)
    url = 'http://v18.proteinatlas.org/images/'
    csv_path = 'data/HPAv18RBGY_wodpl.csv'
    save_dir = 'data/raw/external'
    os.makedirs(save_dir, exist_ok=True)
    print('Parent process %s.' % os.getpid())
    img_list = list(pd.read_csv(csv_path)['Id'])
    img_splits = np.array_split(img_list, process_num)
    assert sum([len(v) for v in img_splits]) == len(img_list)
    p = Pool(process_num)
    for (i, split) in enumerate(img_splits):
        p.apply_async(download, args=(str(i), list(split), url, save_dir, image_size))
    print('Waiting for all subprocesses done...')
    p.close()
    p.join()
    print('All subprocesses done.')
```
</details>
<!---Documatic-block-tools.download.main-end--->
<!---Documatic-section-main-end--->

# #
<!---Documatic-section-tools.download.main-end--->

[_Documentation generated by Documatic_](https://www.documatic.com)